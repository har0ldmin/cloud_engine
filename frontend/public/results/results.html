{% extends 'template/index.html' %}

{% block content %}


<!-- Vendor CSS Files -->
<link href="../solution/assets/vendor/bootstrap-icons/bootstrap-icons.css" rel="stylesheet">
<link href="../solution/assets/vendor/aos/aos.css" rel="stylesheet">
<link href="../solution/assets/vendor/glightbox/css/glightbox.min.css" rel="stylesheet">
<link href="../solution/assets/vendor/swiper/swiper-bundle.min.css" rel="stylesheet">

<!-- Template Main CSS File -->
<link href="../solution/assets/css/solution.css" rel="stylesheet">

<style>
    header {
        margin-bottom: 12vh;
    }

    .portfolio-item {
        width: 32vh;
        height: 38vh;
        margin: 2%;
    }

    .portfolio-container {
        margin-top: 5%;
    }

    .portfolio-flters {
        margin-top: 5vh !important;
    }

    .portfolio-flters li {
        margin-left: 1.5% !important;
        margin-right: 1.5% !important;
    }

    button[type="purchase"] {
        background-color: #F79901 !important;
        border-color: #F79901 !important;
        border-radius: 5px;
        font-size: 14px !important;
        padding: 5px 10px;
    }

    button[type="purchase"]:hover {
        background-color: #f79901bd !important;
        border-color: #f79901bd !important;
        border-radius: 10px;
        border-radius: 5px;
    }

    .button-container {
        width: 100%;
        display: flex;
        flex-direction: column;
        margin-top: 13px;
    }


    /* Checkout */
    .checkout {
        position: fixed !important;
        bottom: 20px;
        right: 260px;
        z-index: 1 !important;
        background: skyblue;
        width: 55px;
        height: 55px;
        border-radius: 50px;
        color: white;
        font-size: 22px;
        font-weight: bolder;
    }

    .checkout i {
        font-size: 24px;
        color: #fff;
        line-height: 0;
    }

    .checkout:hover,
    .checkout:hover~.checkoutCounter {
        transform: translateX(15px);
        transition: transform 0.77s ease;
    }
    
    /* active on both checkout and checkoutCounter */
    .checkout.active,
    .checkoutCounter.active {
        color: #fff;
        animation: moveAndComeBack 1.5s ease;
    }

    @keyframes moveAndComeBack {
        0% {
            transform: translateX(10px);
        }

        50% {
            transform: translateX(20px);
        }

        100% {
            transform: translateX(0px);
        }
    }

    /* Checkout helper */
    .checkoutHelper {
        position: fixed !important;
        bottom: 9%;
        right: 5%;
        z-index: 1 !important;
        padding: 10px 20px;
        background: rgba(24, 96, 124, 0.82);
        width: 10%;
        height: 7%;
        border-radius: 10px 10px 10px 0px;
        color: white;
        font-size: 14px;
        font-weight: bold;
    }

    /* checkout Counter */
    .checkoutCounter {
        position: fixed !important;
        bottom: 5.7%;
        right: 13.9%;
        z-index: 1 !important;
        background: rgb(106, 177, 206);
        width: 26px;
        height: 26px;
        border-radius: 50px;
        color: white;
        font-size: 22px;
        font-weight: bolder;
    }
</style>


<main style="margin-top: 3%;">


    <!-- This section displays the results of the portfolio. It contains a filter for AWS, Google Cloud Platform, and Microsoft Azure. The results are displayed in a masonry layout. -->
    <section id="portfolio" class="portfolio sections-bg"">
        <div class=" container" data-aos="fade-up">

        <div class="section-header">
            <h2>Results</h2>
            <p>Maybe you would like to have a look on these.</p>
        </div>


        <!-- This code block contains the HTML code for a portfolio section with a filter functionality. The portfolio items are displayed in a masonry layout and can be filtered by AWS, Google Cloud Platform, and Microsoft Azure. The portfolio items are contained within a div with class "portfolio-container". -->
        <div class="portfolio-isotope" data-portfolio-filter="*" data-portfolio-layout="masonry"
            data-portfolio-sort="original-order" data-aos="fade-up" data-aos-delay="100">

            <div>
                <ul class="portfolio-flters">
                    <li data-filter="*" class="filter-active">All</li>
                    <li data-filter=".filter-app">AWS</li>
                    <li data-filter=".filter-product">Google Cloud Platform</li>
                    <li data-filter=".filter-branding">Microsoft Azure</li>
                </ul><!-- End Portfolio Filters -->
            </div>

            <div class="row gy-4 portfolio-container" id="all-container" style="margin-left: 7%;">
                <!-- Contents Here -->
            </div>
        </div>

        <!-- 
        This code block creates a container for the ChatGPT's recommendation section in the results page of the web application. 
        It contains a header with a robot icon, a div for displaying the recommendation, and two other divs for displaying messages when there is no response or when the AI is fetching data. 
        The recommendation div is initially hidden and will be displayed once the AI generates a recommendation. 
        -->
        <div id="GPTcontainer" style="padding: 0px 80px; padding-top: 10%;">
            <div>
                <h4 style="text-align: center; font-weight: bolder; color: green !important; padding-bottom: 2%;">
                    ChatGPT's Recommendation &nbsp; <i class="fa-solid fa-robot"></i>
                </h4>
                <!-- Contents Here -->
                <div style="background-color: rgb(242, 242, 242); border-radius: 15px;">
                    <div id="gptNoResponse"
                        style="text-align: center; color: grey; font-size: 18px; font-weight: 600; padding: 30px 0px; display: block;">
                        There is nothing to display yet.
                    </div>
                    <div id="gptFetching"
                        style="text-align: center; color: grey; font-size: 20px; padding: 50px 0px; display: none;">
                        Your AI buddy is hard at work, brewing up some data magic. . . &nbsp; <i
                            class="fa-solid fa-robot fa-spin" style="color: #F79901; font-size: 30px;"></i>
                    </div>
                    <div id="chatGPTrecommendation"
                        style="color: grey; font-size: 16px; padding: 50px 50px; display: none;">
                        <!-- Contents Here -->
                    </div>
                </div>
            </div>
        </div>
    </section><!-- End Portfolio Section -->



    <!-- 
    This code block displays a message to add items to the wishlist and a checkout button with an onclick function to execute the checkout() function. 
    The number of items in the cart is displayed on the button.
    -->
    <div class="checkoutHelper">Add your items to your wishlist!</div>
    <a href="#" class="checkout d-flex align-items-center justify-content-center" id="checkoutBtn"
    onclick="checkout()"><i class="fa fa-shopping-cart" aria-hidden="true"></i></a>
    <a class="checkoutCounter" id="checkoutCounter" style="align-items: center; text-align: center; justify-content: center; display: flex; font-size: 18px;">0</a>
</main> 




<div id="preloader"></div>


<!-- Vendor JS Files -->
<script src="../solution/assets/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../solution/assets/vendor/aos/aos.js"></script>
<script src="../solution/assets/vendor/glightbox/js/glightbox.min.js"></script>
<script src="../solution/assets/vendor/purecounter/purecounter_vanilla.js"></script>
<script src="../solution/assets/vendor/swiper/swiper-bundle.min.js"></script>
<script src="../solution/assets/vendor/isotope-layout/isotope.pkgd.min.js"></script>

<!-- Template Main JS File -->
<script src="../solution/assets/js/main.js"></script>

<!-- Receive filtered data -->
<!-- 
This script defines functions to display items based on filtered data. 
The function "getParameterByName" retrieves the value of a specified parameter from the URL. 
The function "receiveFilteredData" retrieves the filtered data from the URL and calls the "displayItems" function to display the items. 
The function "displayItems" takes in the filtered data and generates HTML code to display the items. 
The function uses the service name to determine the corresponding image URL and generates HTML code to display the image and other item details. 
-->
<script>
    function getParameterByName(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
    }

    async function receiveFilteredData() {
        var filteredDataParam = getParameterByName('filteredData');
        var categoryName = getParameterByName("categoryName");
        console.log(categoryName);

        var filteredData = JSON.parse(filteredDataParam);
        await displayItems(filteredData);

        //await displayGPTrecommendation(categoryName, filteredData);
    }

    function displayItems(filteredData) {
        let output = "";
        let imgUrl = "";

        // ../solution/assets/img/portfolio/product-1.jpg" class="img-fluid

        filteredData.forEach(element => {
            console.log(element);

            if (element.serviceName == "Amazon EC2") {
                imgUrl = "../solution/assets/img/services/AmazonEC2.png";
            }
            else if (element.serviceName == "Amazon Elastic Container Service (ECS)") {
                imgUrl = "../solution/assets/img/services/AmazonECS.png";
            }
            else if (element.serviceName == "Amazon RDS") {
                imgUrl = "../solution/assets/img/services/AmazonRds.png";
            }
            else if (element.serviceName == "AWS Step Functions") {
                imgUrl = "../solution/assets/img/services/AmazonStepFun.png";
            }
            else if (element.serviceName == "Amazon VPC") {
                imgUrl = "../solution/assets/img/services/AmazonVPC.png";
            }
            else if (element.serviceName == "AWS Lambda") {
                imgUrl = "../solution/assets/img/services/AwsLambda.png";
            }
            else if (element.serviceName == "Azure Kubernetes Service (AKS)") {
                imgUrl = "../solution/assets/img/services/AzureAKS.png";
            }
            else if (element.serviceName == "Azure App Service") {
                imgUrl = "../solution/assets/img/services/AzureAppService.png";
            }
            else if (element.serviceName == "Azure SQL Database") {
                imgUrl = "../solution/assets/img/services/AzureCloudDatabase.png";
            }
            else if (element.serviceName == "Azure Functions") {
                imgUrl = "../solution/assets/img/services/AzureFunc.png";
            }
            else if (element.serviceName == "Azure Virtual Machines") {
                imgUrl = "../solution/assets/img/services/AzureVirtualMachine.png";
            }
            else if (element.serviceName == "Azure Virtual Network") {
                imgUrl = "../solution/assets/img/services/AzureVirtualNetwork.png";
            }
            else if (element.serviceName == "Google App Engine") {
                imgUrl = "../solution/assets/img/services/GoogleAppEngine.jpg";
            }
            else if (element.serviceName == "Google Cloud Functions") {
                imgUrl = "../solution/assets/img/services/GoogleCloudFunc.png";
            }
            else if (element.serviceName == "Google Cloud SQL") {
                imgUrl = "../solution/assets/img/services/GoogleCloudSQL.jpg";
            }
            else if (element.serviceName == "Google Compute Engine") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "Google Kubernetes Engine (GKE)") {
                imgUrl = "../solution/assets/img/services/GoogleGKE.png";
            }
            else if (element.serviceName == "Google Virtual Private Cloud (VPC)") {
                imgUrl = "../solution/assets/img/services/GoogleVPC.png";
            }
            // No photos below
            else if (element.serviceName == "AWS Elastic Beanstalk") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "Amazon Aurora") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "Azure Cosmos DB") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "AWS Batch") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "Amazon EventBridge") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "Azure Logic Apps") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else if (element.serviceName == "Azure Durable Functions") {
                imgUrl = "../solution/assets/img/services/GoogleComputeEngine.png";
            }
            else {
                imgUrl = "../solution/assets/img/services/GoogleAppEngine.jpg";
            }

            let p = "";

            if (element.provider == "AWS") {
                p = "filter-app";
            }

            else if (element.provider == "Google Cloud Platform") {
                p = "filter-product";
            }

            else {
                p = "filter-branding";
            }

            output += `
            <div class="col-xl-4 col-md-6 portfolio-item ${p}">
                <div class="portfolio-wrap">
                    <div id='myModal1' style='display: none;'>
                        <p>This is a description for App 1.</p>
                    </div>

                    <a href="#myModal1" data-glightbox="type: inline; href: #myModal1" data-gallery="portfolio-gallery-app" class="glightbox">
                        <img src="${imgUrl}" class="img-fluid" alt="">
                    </a>
                    
                    <div class="portfolio-info" ">
                        <h4><a href="#" onclick="addToList(this.parentElement.parentElement.parentElement, this.parentElement.parentElement, '${element.provider}', '${element.serviceName}')" title="More Details">${element.provider}</a></h4>
                        <p>${element.serviceName}</p>
                    </div> 
                </div>
            </div>
            `
        });

        document.getElementById("all-container").innerHTML = output;
    }


    // global variable
    let cart = [];

    function addToList(element, element2, provider, serviceName) {
        event.preventDefault();

        alert("Added to the cart!");
        element.style.backgroundColor = "skyblue";
        element2.style.backgroundColor = "skyblue";

        let details = [provider, serviceName];
        cart.push(details);

        document.getElementById('checkoutCounter').innerHTML = cart.length;
        document.getElementById('checkoutBtn').classList.add('active');
        document.getElementById('checkoutCounter').classList.add('active');
    }


    function checkout() {
        const userId = localStorage.getItem("id");
        const token = localStorage.getItem("token");
        if (!userId) {
            window.location.href = "../auth/login";
            return;
        }

        localStorage.setItem("wishlist", JSON.stringify(cart));
        window.location.href = "/wishlist";
    }


    document.addEventListener("DOMContentLoaded", function () {
        receiveFilteredData();
        if (!localStorage.getItem("wishlist")) {
            console.log("wishlist not in local storage, initialising..");
            localStorage.setItem("wishlist", []);
        }
        else {
            console.log("wishlist already in local storage");
        }
    });
</script>




<!-- 
This script defines an async function called displayGPTrecommendation which takes in two parameters: serviceName and data. 

It creates a question string from the retrieved data and sends it to the OpenAI GPT-3 API to generate a response. 

The response is then displayed on the webpage.

The function first checks the length of the data array to determine whether to recommend the best service or the top 3 services. 

It then creates a string of data for each service in the array and concatenates it with the question string.

The function then sends the question string to the OpenAI GPT-3 API using the fetch() method. 

If the response is successful, the response from the API is displayed on the webpage. If there is an error, an error message is displayed instead.

This script requires an API key to access the OpenAI GPT-3 API.
-->
<script>
    async function displayGPTrecommendation(serviceName, data) {

        // if there are no data, don't fetch to gpt
        if (data.length == 0) {
            return;
        }

        // Make a question String from retrieved data
        var GPTinput = ``;
        if (data.length <= 5) {
            GPTinput = `
            
            Explain pros and cons for each services briefly, and recommend the best service for ${serviceName}.`;
        }
        else {
            GPTinput = `Explain pros and cons for each services briefly, and recommend the best top 3 service for ${serviceName}. Display a line between each services to make the results more distinguishable.`;
        }

        GPTinputData = ``;
        data.forEach(element => {
            GPTinputData += `{${element.serviceName} is the service provided from ${element.provider}. Freetier option is ${element.freeTier} and PayAsYouGo option is ${element.payAsYouGo}.} 
            
            `;
        });

        const questionString = GPTinputData + GPTinput;
        console.log("Asking GPT: " + questionString);

        // ask to Chat GPT
        const API_KEY = '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';
        
        if (questionString) {

            // hide gptNoResponse
            var gptNoResponse = document.getElementById("gptNoResponse");
            gptNoResponse.style.display = "none";

            // show gptFetching animation
            var gptFetching = document.getElementById("gptFetching");
            gptFetching.style.display = "block";

            try {
                //showLoadingGPTDash();

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + `${API_KEY}`,
                    },
                    body: JSON.stringify({
                        "model": 'gpt-3.5-turbo',
                        "messages":
                            [{
                                "role": 'user',
                                "content": questionString
                            }]
                    }),
                });
                if (response.ok) {

                    console.log("response ok received");
                    const data = await response.json();
                    // save response from gpt to variable
                    var responseFromGPT = data.choices[0].message.content;
                    // check response from gpt
                    console.log(responseFromGPT);

                    // hide gptFetching
                    gptFetching.style.display = "none";

                    // display response from gpt
                    var chatGPTrecommendation = document.getElementById("chatGPTrecommendation");
                    chatGPTrecommendation.style.display = "block";
                    chatGPTrecommendation.innerText = responseFromGPT;

                } else {
                    console.log(response + 'Error occured during process the request. Retrying...');
                    // display api rate limit issue
                    var chatGPTrecommendation = document.getElementById("chatGPTrecommendation");
                    chatGPTrecommendation.style.display = "block";
                    chatGPTrecommendation.innerText = "Please reload the page. There was an issue with API rate limit.";
                }
            } catch (error) {
                console.error(error + 'Error occured during process the request. Retrying...');
                // display api rate limit issue
                var chatGPTrecommendation = document.getElementById("chatGPTrecommendation");
                chatGPTrecommendation.style.display = "block";
                chatGPTrecommendation.innerText = "Please reload the page. There was an issue with API rate limit.";
            }
        }
    }
</script>


{% endblock %}